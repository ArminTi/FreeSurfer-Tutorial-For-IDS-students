# For IDS students, Neuroimaging department FreeSurfer Tutorial Part 3##
## By Armin Toghi, Nov 2024

## Quick notes: 
## 1. We use Neurodesk for this tutorial
## 2. Use version 7.3.2 (or above)
## 3. Be patient while working with freesurfer: you will probably get many error while you are working

# Step 1: Initialize: Like the previous section you should mark SUBDIR
# ------------------------------------------------------------------
source /opt/freesurfer-7.3.2/SetUpFreeSurfer.sh
export SUBJECTS_DIR=/neurodesktop-storage/freesurfer-output
cd /home/jovyan/data

# Step 3: Manual Registration
# ------------------------------------------------------------------

freeview -v swarsub-01_ses-mri_task-facerecognition_run-01_bold.nii \
    $SUBJECTS_DIR/test-subject/mri/orig.mgz:visible=0 -f \
    $SUBJECTS_DIR/test-subject/surf/lh.white \
    $SUBJECTS_DIR/test-subject/surf/rh.white \
    -viewport cor -transform-volume

# Step 4: Automated Registration
# ------------------------------------------------------------------

bbregister --mov swarsub-01_ses-mri_task-facerecognition_run-01_bold.nii --bold --s test-subject --lta register.lta

# Step 5: Check Automated Registration
# ------------------------------------------------------------------
cat register.lta

freeview -v $SUBJECTS_DIR/test-subject/mri/orig.mgz:visible=0 \
    swarsub-01_ses-mri_task-facerecognition_run-01_bold.nii:reg=register.lta -f \
    $SUBJECTS_DIR/test-subject/surf/lh.white \
    $SUBJECTS_DIR/test-subject/surf/rh.white \
    -viewport cor -transform-volume
	
# Step 4: Mapping fMRI data to the freesurfer output
# ------------------------------------------------------------------
#You will need a GLM result first: called Real_vs_Scrambled_P_value.nii
#You will need registeration file as well
	
	
freeview -v $SUBJECTS_DIR/test-subject/mri/orig.mgz \
    $SUBJECTS_DIR/test-subject/mri/aparc+aseg.mgz:colormap=lut:opacity=0.2 \
    Real_vs_Scrambled_P_value.nii:reg=register.lta:colormap=heat:heatscale=2,2,4 -colorscale \
    -viewport coronal


# Step 5: Mapping fMRI data to the surface (View sig map on left hemisphere)
# -------------------------------------------------------------------
## Resample

mri_vol2surf --mov Real_vs_Scrambled_P_value.nii \
    --reg register.lta \
    --projfrac 0.5 --interp nearest \
    --hemi lh --o lh.sig.mgh

#check dimention with: mri_info lh.sig.mgh

## View on surface

freeview -f $SUBJECTS_DIR/test-subject/surf/lh.inflated:annot=aparc.annot:annot_outline=1:overlay=lh.sig.mgh:overlay_threshold=2,5 \
    -viewport 3d
	